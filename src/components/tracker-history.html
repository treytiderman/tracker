{{ define "tracker_history" }}

<script>
    const dialogs = {}
</script>

{{ range $Entry := .Entries }}

<dialog id="dialog_{{$Entry.Id}}" class="tt-dialog">
    <script>
        dialogs["{{$Entry.Id}}"] = document.getElementById("dialog_{{$Entry.Id}}")
        dialogs["{{$Entry.Id}}"].addEventListener("pointerdown", (event) => {
            if (event.target === dialogs["{{$Entry.Id}}"]) dialogs["{{$Entry.Id}}"].close()
        })
    </script>
    <form class="flex-col gap-8 pad-4 h-full" method="post"
        action="/htmx/tracker/log-update?tracker_id={{$.Tracker.Id}}&entry_id={{$Entry.Id}}">

        <!-- <div class="flex-wrap flex-even break-md items-end gap-4" hidden>
            <div class="grid">
                <label class="tt-label" for="date-1">Date</label>
                <input type="date" class="tt-input" id="date-1" name="date-1" value="2024-07-07">
            </div>

            <div class="grid gap-1">
                <label class="flex gap-2 w-full" for="time-1">
                    <div>Time</div>
                    <div id="timezone-1" class="dim" style="margin-left: auto;">GMT-0500 (Central Daylight Time)
                    </div>
                </label>
                <input type="time" class="tt-input" id="time-1" name="time-1" value="20:57">
            </div>
        </div> -->

        {{ range $Field := $.Tracker.Fields }}

        {{ if eq $Field.Type "number" }}
        <div class="grid">

            {{ range $Log := $Entry.Logs }}
            {{ if eq $Log.Field_Id $Field.Id }}
            <label class="tt-label" for="log_{{$Log.Id}}">{{ $Field.Name }}</label>
            <input type="number" class="tt-input" id="log_{{$Log.Id}}" name="log_{{$Log.Id}}"
                step="{{ decimal_places_to_step_size $Field.Number.Decimal_Places }}" placeholder="0"
                value="{{$Log.Present}}" required>
            {{ end }}
            {{ end }}

        </div>
        {{ end }}

        {{ if eq $Field.Type "option" }}
        <div class="grid">

            {{ range $Log := $Entry.Logs }}
            {{ if eq $Log.Field_Id $Field.Id }}
            <label class="tt-label" for="log_{{$Log.Id}}">{{ $Field.Name }}</label>
            <select class="tt-input" id="log_{{$Log.Id}}" name="log_{{$Log.Id}}" required>

                {{ range $Option := $Field.Options }}
                {{ if eq $Log.Option_Value $Option.Value }}
                <option value="{{ $Option.Value }}" selected>{{ $Option.Value }}: {{ $Option.Name }}</option>
                {{ else }}
                <option value="{{ $Option.Value }}">{{ $Option.Value }}: {{ $Option.Name }}</option>
                {{ end }}
                {{ end }}

            </select>
            {{ end }}
            {{ end }}

        </div>
        {{ end }}

        {{ end }}

        <div class="flex-col grow">
            <label for="entry_note" class="tt-label">Note</label>
            <textarea id="entry_note" name="entry_note" placeholder="Log Note..." rows="4" class="tt-input grow"
                style="resize: none">{{ $Entry.Notes }}</textarea>
        </div>

        <div class="flex flex-even gap-4">
            <button type="button" id="add_field" class="tt-button"
                onclick="document.getElementById('dialog_{{$Entry.Id}}').close()">
                Close
            </button>
            <button type="submit" class="tt-button tt-color-yellow">
                Update
            </button>
        </div>

    </form>
</dialog>

{{ end }}

<div class="grid gap-4">

    {{ if .Entries }}

    <h2>History</h2>

    {{ end }}

    {{ range $Entry := .Entries }}

    <hr>

    <div id="entry_{{$Entry.Id}}" class="grid gap-2">
        <div class="flex items-center gap-4 dim">
            <div class="grow">{{ $Entry.Timestamp }}</div>
            <a href="/entry-view?tracker_id={{$.Tracker.Id}}&entry_id={{$Entry.Id}}"
                class="tt-icon-button dim tt-color-primary-hover" title="View Entry">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
                </svg>
            </a>
            <button id="edit_row_1" class="tt-icon-button dim tt-color-yellow-hover" title="Edit Log"
                onclick="document.getElementById('dialog_{{$Entry.Id}}').showModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                    <path d="m15 5 4 4" />
                </svg>
            </button>
            <a href="/htmx/tracker/log-delete?tracker_id={{$.Tracker.Id}}&entry_id={{$Entry.Id}}"
                class="tt-icon-button dim tt-color-red-hover"
                onclick="return confirm('Are you sure you want to delete this log?')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18" />
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                </svg>
            </a>
        </div>

        {{ range $Entry.Logs }}
        <div class="flex items-center gap-4">
            <div class="dim"> > </div>
            <div>{{ .Present }}</div>
            <label class="dim">{{ .Field_Name }}</label>
        </div>
        {{ end }}

        <div id="entry_notes_{{$Entry.Id}}" class="tt-markdown flow"> {{ render_markdown $Entry.Notes }} </div>
        <script>
            var md = document.getElementById("entry_notes_{{$Entry.Id}}")
            var md_count = 0
    
            for (const child1 of md.children) {
                if (child1.tagName === "UL") {
                    for (const child2 of child1.children) {
                        if (child2.tagName === "LI") {
                            if (child2.innerHTML.startsWith("[ ] ") || child2.innerHTML.startsWith("[x] ")) {
                                md_count += 1
    
                                const div = document.createElement("div")
                                div.classList = "flex items-baseline gap-4"
    
                                const input = document.createElement("input")
                                input.classList = "tt-input"
                                input.type = "checkbox"
                                input.name = "chx-{{$Entry.Id}}-" + md_count
                                input.id = "chx-{{$Entry.Id}}-" + md_count
                                input.addEventListener("click", event => event.preventDefault())
                                div.appendChild(input)
    
                                const label = document.createElement("label")
                                label.classList = "tt-label-inline"
                                label.htmlFor = "chx-{{$Entry.Id}}-" + md_count
                                label.innerText = "error label"
                                label.style.fontSize = "var(--font-size)"
                                div.appendChild(label)
    
                                // Empty Checkbox
                                if (child2.innerHTML.startsWith("[ ] ")) {
                                    label.innerText = child2.innerText.replace("[ ] ", "")
                                    child2.style.display = "block"
                                    child2.innerHTML = ""
                                    child2.appendChild(div)
                                }
    
                                // Checked Checkbox
                                if (child2.innerHTML.startsWith("[x] ")) {
                                    const split = child2.innerHTML.split(/<br>(.*)/s)
                                    label.innerText = split[0].replace("[x] ", "")
                                    input.checked = true
                                    child2.style.display = "block"
                                    const child3 = document.createElement('div')
                                    child2.innerHTML = ""
                                    child2.appendChild(div)
                                    child2.appendChild(child3)
                                    child3.outerHTML = split[1]
                                }
                            }
                        }
                    }
                }
            }
        </script>
    </div>

    <script>
        var tracker_history__date = new Date(document.getElementById("entry_{{$Entry.Id}}").children[0].children[0].innerText)
        var tracker_history__string = tracker_history__date.toLocaleString().replace(",", "")
        document.getElementById("entry_{{$Entry.Id}}").children[0].children[0].innerText = tracker_history__string
    </script>

    {{ end }}

</div>

<br><br>

{{ end }}